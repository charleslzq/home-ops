# Proxmox Module

Setup VMs on proxmox

## Nodes

name | node | ip | installed | usage
--- | --- | --- | --- | ---
bran | skypiea | 10.10.30.33 | wireguard, keepalived(ip: 10.10.30.32) | wireguard relay
arya | avalon | 10.10.30.31 | wireguard, keepalived(ip: 10.10.30.32) | wireguard relay
rayleigh-1 | avalon | 10.10.30.99 | consul, consul-template | consul server
rayleigh-2 | skypiea | 10.10.30.100 | consul, consul-template | consul server
rayleigh-3 | skypiea | 10.10.30.101 | consul, consul-template | consul server
yuki-1 | avalon | 10.10.30.121 | consul, consul-template, vault, keepalived(ip: 10.10.30.120)  | vault
yuki-2 | skypiea | 10.10.30.122 | consul, consul-template, vault, keepalived(ip: 10.10.30.120)  | vault
roger-1 | avalon | 10.10.30.210 | consul, consul-template, nomad | nomad server
roger-2 | skypiea | 10.10.30.211 | consul, consul-template, nomad | nomad server
roger-3 | skypiea | 10.10.30.212 | consul, consul-template, nomad | nomad server
rin | skypiea | 10.10.30.234 | consul, consul-template, nomad, docker | nomad client, dns
sakura | avalon | 10.10.30.236 | consul, consul-template, nomad, docker | nomad client, dns
joker-1 | avalon | 10.10.30.111 | consul, consul-template, nomad, docker, keepalived(ip: 10.10.30.110) | nomad client, gateway
joker-2 | skypiea | 10.10.30.112 | consul, consul-template, nomad, docker, keepalived(ip: 10.10.30.110) | nomad client, gateway
2c | avalon | 10.10.30.50 | consul, consul-template, nomad, docker | nomad client
2d | skypiea | 10.10.30.51 | consul, consul-template, nomad, docker | nomad client
1d | skypiea | 10.10.30.52 | consul, consul-template, nomad, docker | nomad client

## Vault tls

The tls certificates for vault in proxmox is generated by vault on vagrant VM. To make VMs accept these certificates,
the ca certificate is distributed to every vm (except wireguard relays), including local vagrant vm.

## Manually setup consul acl token, and unseal vault

After `terraform apply`, all nodes should be setup, but vaults ares sealed. Before proceed to integration part,
one should setup agent token for consul servers and vaults, and then initialize and unseal vaults.

1. Bootstrap consul acl token
2. Create policies for consul servers and vault servers
3. Generate tokens for consul servers and vault servers, modify consul config file manually and restart consul service.
4. Initialize and unseal vault.

```hcl
 //consul server policy:
node_prefix "rayleigh" {
 policy = "write"
}
node_prefix "" {
 policy = "read"
}
service_prefix "" {
 policy = "read"
}

 // vault server policy:
node_prefix "" {
 policy = "read"
}
service_prefix "" {
 policy = "read"
}
node_prefix "yuki" {
 policy = "write"
}
agent_prefix "yuki" {
 policy = "write"
}

 // vault service policy:
service "yuki" {
  policy = "write"
}
key_prefix "vault/" {
 policy = "write"
}
session_prefix "yuki" {
 policy = "write"
}
```
